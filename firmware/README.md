# Gekkokapula firmware

# Files in the project
The project was originally made in Simplicity Studio.
Simplicity Studio, however, was found difficult to use for development
since a project opened on another machine was usually broken, its
configuration generators regularly broke something in the project,
and it was quite frustrating in general. Now the code can be compiled
with `make`, and Simplicity Studio is only needed to generate the
radio configuration.

*InitDevice.c* and *InitDevice.h* have been generated by
Simplicity Studio long ago based on the *\*.hwconf* file, which may
not open properly on a newer version. Other old generated files
have been removed.

A project for generating the RAIL configuration is in a different
directory, *../railconfig*. The generated files *rail_config.c*
and *rail_config.h* are compiled as a part of the program.

The application code is under src/ and inc/.

Font is from https://github.com/dhepper/font8x8/

# Compiling and flashing
## Using Visual Studio Code
The project includes configuration for Visual Studio Code and the
Cortex-Debug extension.
To develop with Visual Studio Code, install the extensions
**Arm toolchain Linux** (or **Arm toolchain Windows** or **Arm toolchain macOS**)
from **Chipcode**,
**Cortex-Debug** from **marus25**,
and **RTOS Views** from **mcu-debug**.

Install OpenOCD. See [flashing tutorial](flashing.md) for details.

Choose *File -> Open Folder* and open this firmware directory in VS Code.

To build or flash the firmware, press *Ctrl+Shift+B*.
The build task will ask for the hardware model, SWD adapter type
and whether you want to only build or also flash the firmware.

To use the debugger, press *F5*.
If you have made changes to code, remember to flash the new firmware
before starting debugging.

## Alternative way: using command line tools only (on Linux)
If you have installed the Arm toolchain as an extension for VS Code,
you can also use it from command line by first doing:

    export PATH="${HOME}/.vscode/extensions/chipcode-nl.gcc-arm-linux-1.0.1/bin:$PATH"

If not, install the toolchain first. For example, on Ubuntu:

    sudo apt install make gcc-arm-none-eabi libnewlib-arm-none-eabi gdb-multiarch openocd

See [flashing tutorial](flashing.md) for details on setting up OpenOCD.

Compiling the firmware:

    make -j4 KAPULA=v2

Compiling and flashing the firmware:

    make -j4 flash KAPULA=v2

Running OpenOCD to use a debugger or to view RTT debug prints:

    openocd -f openocd/rtt.cfg

Replace KAPULA=v2 with KAPULA=eka for the first version built
from 2.4 GHz radio modules. The first version has had some problems
with flashing but try this a couple of times if it does not work
the first time:

    openocd -f openocd/flash_v1.cfg

If you have an ST-Link or CMSIS-DAP instead of J-Link as your SWD adapter,
do this before flashing or starting OpenOCD:

    export SWD_ADAPTER=stlink
    # or
    export SWD_ADAPTER=cmsis-dap
