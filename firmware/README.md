# Gekkokapula firmware

# Files in the project
The project was originally made in Simplicity Studio.
Simplicity Studio, however, was found difficult to use for development
since a project opened on another machine was usually broken, its
configuration generators regularly broke something in the project,
and it was quite frustrating in general. Now the code can be compiled
with `make`, and Simplicity Studio is only needed to generate the
radio configuration.

*InitDevice.c* and *InitDevice.h* have been generated by
Simplicity Studio long ago based on the *\*.hwconf* file, which may
not open properly on a newer version. Other old generated files
have been removed.

A project for generating the RAIL configuration is in a different
directory, *../railconfig*. The generated files *rail_config.c*
and *rail_config.h* are compiled as a part of the program.

The application code is under src/ and inc/.

Font is from https://github.com/dhepper/font8x8/

# Compiling and flashing
## Using Visual Studio Code
The project includes configuration for Visual Studio Code and the
Cortex-Debug extension.
To develop with Visual Studio Code, install the extensions
*Arm toolchain Linux* (or *Arm toolchain Windows* or *Arm toolchain macOS*)
from *Chipcode* and *Cortex-Debug* from *marus25*.

Install OpenOCD. On Ubuntu or Debian, do
`sudo apt install openocd` .
On Windows, download it from
https://github.com/xpack-dev-tools/openocd-xpack/releases/ .
Some additional configuration may be needed for USB device permissions
on Linux or to use the right USB driver on Windows.

TODO: improve tasks.json and launch.json and write instructions to use it.

## Alternative way: using command line tools only
If you have installed the Arm toolchain as an extension for VS Code,
you can also use it from command line by first doing:

    export PATH="${HOME}/.vscode/extensions/chipcode-nl.gcc-arm-linux-1.0.1/bin:$PATH"

If not, install the toolchain first. For example, on Ubuntu:

    sudo apt install make gcc-arm-none-eabi libnewlib-arm-none-eabi gdb-multiarch openocd

Compiling the firmware:

    make -j4 KAPULA=v2

Compiling and flashing the firmware:

    make -j4 flash KAPULA=v2

Running OpenOCD to use a debugger or to view RTT debug prints:

    openocd -f openocd/rtt.cfg

Replace KAPULA=v2 with KAPULA=eka for the first version built
from 2.4 GHz radio modules. The first version has had some problems
with flashing but try this a couple of times if it does not work
the first time:

    openocd -f openocd/v1_flash_rtt.cfg

If you have an ST-Link or CMSIS-DAP instead of J-Link as your SWD adapter,
do this before flashing or starting OpenOCD:

    export SWD_ADAPTER=stlink
    # or
    export SWD_ADAPTER=cmsis-dap
